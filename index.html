<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Image Vault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Google Sign-in API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta name="google-signin-client_id" content="637709229002-0uaqiflhu41koahqpfcgosn36gee5ud5.apps.googleusercontent.com">
    <meta name="google-signin-cookiepolicy" content="single_host_origin">
    <meta name="google-signin-scope" content="profile email https://www.googleapis.com/auth/drive.file">
    <style>
        :root {
            --primary: #e2e8f0;
            --secondary: #3b82f6;
            --accent: #ef4444;
            --light: #1e293b;
            --success: #22c55e;
            --dark: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --hover-bg: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, var(--dark), #1e1b4b);
            padding: 20px;
            color: var(--text-primary);
            
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            margin-top: 120px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 40px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        .auth-section {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .google-logo {
            margin-bottom: 30px;
        }

        .google-logo img {
            width: 180px;
            height: auto;
        }

        .google-btn {
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
            padding: 12px 25px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 20px auto;
            width: 100%;
            letter-spacing: 0.25px;
        }

        .google-btn img {
            width: 18px;
            height: 18px;
        }

        .google-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 3px rgba(60,64,67,0.3);
            border-color: #dadce0;
        }

        .google-btn:active {
            background: #f1f3f4;
            box-shadow: 0 1px 3px rgba(60,64,67,0.5);
        }

        .or-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: #666;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .or-divider span {
            padding: 0 10px;
        }

        input[type="password"] {
            width: 100%;
            padding: 15px 20px;
            margin: 15px 0;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--dark);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        input[type="password"]:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
            outline: none;
            transform: translateY(-2px);
        }

        input[type="password"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        button {
            background: var(--secondary);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .choose-files-btn {
            width: 100%;
            background: var(--secondary);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }

        .choose-files-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .choose-files-btn i {
            font-size: 24px;
        }

        .controls {
            background: var(--dark);
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .sort-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .sort-btn {
            background: var(--dark) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: var(--text-secondary) !important;
            padding: 8px 16px !important;
            border-radius: 8px !important;
            transition: all 0.3s !important;
        }

        .sort-btn:hover {
            border-color: var(--secondary) !important;
            color: var(--text-primary) !important;
        }

        .sort-btn.active {
            background: var(--secondary) !important;
            color: white !important;
            border-color: var(--secondary) !important;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .image-card {
            background: var(--dark);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
            border-color: var(--secondary);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-info {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            min-height: 60px;
            background: var(--card-bg);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .image-info span {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.3;
            word-break: break-word;
            white-space: normal;
        }

        .image-info .buttons {
            display: flex;
            gap: 5px;
            align-items: flex-start;
            min-width: fit-content;
        }

        .image-info button {
            padding: 5px;
            background: transparent;
            font-size: 14px;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-info button:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .image-info .name-edit-container {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            flex: 1;
            padding-right: 10px;
        }

        .edit-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--secondary);
            border-radius: 8px;
            font-size: 13px;
            display: none;
            margin-right: 10px;
            min-width: 0;
            line-height: 1.3;
            background: var(--dark);
            color: var(--text-primary);
        }

        .edit-name-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .edit-btn {
            color: #666 !important;
            display: flex !important;
        }

        .edit-btn i {
            font-size: 14px;
        }

        .save-btn, .cancel-btn {
            display: none !important;
            color: #666 !important;
            visibility: hidden;
        }

        .save-btn.show, .cancel-btn.show {
            display: flex !important;
            visibility: visible;
        }

        .delete-btn {
            color: #666 !important;
            display: flex !important;
        }

        .delete-btn:hover {
            color: var(--accent) !important;
        }

        .save-icon-btn {
            background: var(--success);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            padding: 0;
            font-size: 16px;
        }

        .save-icon-btn:hover {
            transform: scale(1.1);
        }

        .save-icon-btn.show {
            display: flex;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            display: none;
            z-index: 2000;
        }

        .loading.active {
            display: block;
        }

        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--dark);
        }

        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(0,0,0,0.8);
        }

        .hidden {
            display: none;
        }

        #logoutBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent);
            border-radius: 25px;
            padding: 10px 20px;
        }

        #logoutBtn i {
            margin-right: 5px;
        }

        .empty-gallery {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .empty-gallery i {
            font-size: 50px;
            color: var(--secondary);
            margin-bottom: 20px;
        }

        /* New styles for backup/import buttons */
        .backup-import-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .backup-btn, .import-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .backup-btn {
            background: #19529d;
        }

        .import-btn {
            background:  #19529d;
        }

        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            width: 300px;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .confirmation-dialog.active {
            display: block;
        }

        .confirmation-dialog h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .confirmation-dialog p {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }

        .confirmation-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .confirm-btn {
            background: var(--accent);
        }

        .cancel-confirm-btn {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔒 Secured Images </h1>
        
        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <input type="password" id="passwordInput" placeholder="Enter your secret password">
            <button onclick="initializeVault()"><i class="fas fa-unlock"></i> Unlock Vault</button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <input type="file" id="imageInput" accept="image/*" multiple hidden onchange="uploadImages()">
            <button class="choose-files-btn" onclick="document.getElementById('imageInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                Choose Images to Upload
            </button>

            <div class="controls">
                <div class="sort-options">
                    <button class="sort-btn active" onclick="sortImages('date')">
                        <i class="fas fa-calendar"></i> Date
                    </button>
                    <button class="sort-btn" onclick="sortImages('name')">
                        <i class="fas fa-font"></i> Name
                    </button>
                    <button class="sort-btn" onclick="sortImages('size')">
                        <i class="fas fa-weight"></i> Size
                    </button>
                </div>
                
                <!-- New backup/import buttons -->
                <div class="backup-import-container">
                    <button class="backup-btn" onclick="backupImages()">
                        <i class="fas fa-download"></i> Backup
                    </button>
                    <input type="file" id="importInput" accept=".json" hidden onchange="importImages()">
                    <button class="import-btn" onclick="document.getElementById('importInput').click()">
                        <i class="fas fa-upload"></i> Import
                    </button>
                </div>
            </div>

            <div class="gallery" id="gallery"></div>
            <button id="deleteAllBtn" style="position: fixed; top: 20px; right: 20px; margin-bottom: 10px; background: rgb(159, 4, 4); border-radius: 25px; padding: 10px 15px; color: white; border: none; cursor: pointer; z-index: 1000; font-size: 12px; ">
                🗑️ Delete All
            </button>
        </div>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i> Processing...
        </div>

        <!-- Add Modal HTML -->
        <div class="modal" id="imageModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">×</span>
                <img id="modalImage" src="/placeholder.svg" alt="Full size image">
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div class="confirmation-dialog" id="confirmationDialog">
            <h3>Confirm Delete</h3>
            <p id="confirmationMessage">Are you sure you want to delete this image?</p>
            <div class="confirmation-buttons">
                <button class="cancel-confirm-btn" onclick="closeConfirmationDialog()">Cancel</button>
                <button class="confirm-btn" id="confirmButton">Delete</button>
            </div>
        </div>

        <script>
            const VAULT_KEY = 'secureImageVault';
            const MASTER_PASSWORD_KEY = 'masterPassword';
            let currentPassword = '';
            let db;
            let googleUser = null;
            let googleDriveToken = null;
            let clickTimer; // Timer for click detection
            const clickDelay = 300; // Delay in milliseconds to differentiate between single and double clicks
            let allImages = []; // Store all loaded images

            // Initialize IndexedDB
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('ImageVaultDB', 1);

                    request.onerror = (event) => {
                        console.error('Database error:', event.target.error);
                        reject('Could not open database');
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('images')) {
                            db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log('Database opened successfully');
                        resolve(db);
                    };
                });
            }

            // Initialize DB when page loads
            initDB().catch(error => {
                console.error('Failed to initialize database:', error);
                alert('Failed to initialize database. Please refresh the page.');
            });

            // Initialize Google Sign-in
            function initGoogleSignIn() {
                gapi.load('client:auth2', async function() {
                    try {
                        await gapi.client.init({
                            apiKey: 'AIzaSyDJTRZzhv1o7WnBVXMZP0mHOGggkns189A',
                            clientId: '637709229002-0uaqiflhu41koahqpfcgosn36gee5ud5.apps.googleusercontent.com',
                            scope: 'https://www.googleapis.com/auth/drive.file email profile',
                            plugin_name: 'Image Vault',
                            cookiepolicy: 'single_host_origin'
                        });

                        // Check if user is already signed in
                        const auth2 = gapi.auth2.getAuthInstance();
                        if (auth2.isSignedIn.get()) {
                            handleSignIn(auth2.currentUser.get());
                        }
                        
                        console.log('Google API initialized successfully');
                    } catch (error) {
                        console.log('Google Sign-In not available:', error);
                    }
                });
            }

            // Add new function to handle sign in
            async function signInWithGoogle() {
                try {
                    showLoading();
                    const googleUser = await gapi.auth2.getAuthInstance().signIn();
                    await handleSignIn(googleUser);
                } catch (error) {
                    console.error('Sign-in error:', error);
                    alert('Failed to sign in with Google. Please try again.');
                } finally {
                    hideLoading();
                }
            }

            // Add new function to handle successful sign in
            async function handleSignIn(googleUser) {
                try {
                    const profile = googleUser.getBasicProfile();
                    const email = profile.getEmail();
                    const token = googleUser.getAuthResponse().access_token;
                    
                    // Save user info
                    localStorage.setItem(MASTER_PASSWORD_KEY, email);
                    currentPassword = email;
                    googleDriveToken = token;
                    
                    // Update UI
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    
                    // Load images
                    await loadImages();
                    
                    console.log('Successfully signed in:', email);
                } catch (error) {
                    console.error('Error handling sign in:', error);
                    alert('Error processing sign in. Please try again.');
                }
            }

            function initializeVault() {
                const password = document.getElementById('passwordInput').value;
                if (!password) {
                    alert('Please enter a password!');
                    return;
                }

                const storedMasterPassword = localStorage.getItem(MASTER_PASSWORD_KEY);
                
                if (!storedMasterPassword) {
                    const confirmPassword = prompt('First time setup: Please confirm your password');
                    if (password !== confirmPassword) {
                        alert('Passwords do not match! Please try again.');
                        return;
                    }
                    localStorage.setItem(MASTER_PASSWORD_KEY, password);
                    alert('Password set successfully! You can now use this password to access your vault.');
                } else if (password !== storedMasterPassword) {
                    alert('Incorrect password! Please try again.');
                    return;
                }

                currentPassword = password;
                loadImages();

                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('deleteAllBtn').style.display = 'block';
            }

            async function uploadImages() {
                const files = document.getElementById('imageInput').files;
                if (!files.length) {
                    alert('No files selected for upload.');
                    return;
                }

                showLoading();
                let uploadedCount = 0;

                try {
                    for (let file of files) {
                        if (file.size > 30 * 1024 * 1024) {
                            hideLoading();
                            alert(`File "${file.name}" is too large! Maximum size per file is 30MB.`);
                            document.getElementById('imageInput').value = '';
                            return;
                        }

                        // Read file
                        const imageData = await readFileAsDataURL(file);
                        
                        // Save to IndexedDB
                        await saveToIndexedDB({
                            name: file.name,
                            data: imageData,
                            timestamp: new Date().toISOString(),
                            password: currentPassword
                        });

                        // Backup to Google Drive if signed in
                        if (googleDriveToken) {
                            await backupToGoogleDrive(file);
                        }

                        uploadedCount++;
                    }

                    document.getElementById('imageInput').value = '';
                    hideLoading();
                    alert(`Successfully uploaded ${uploadedCount} images!`);
                    loadImages();
                } catch (error) {
                    console.error('Upload Error:', error);
                    hideLoading();
                    alert('Error uploading images. Please try again.');
                }
            }

            // Helper function to read file
            function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e);
                    reader.readAsDataURL(file);
                });
            }

            // Save to IndexedDB
            function saveToIndexedDB(imageData) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readwrite');
                    const store = transaction.objectStore('images');
                    const request = store.add(imageData);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // Backup to Google Drive
            async function backupToGoogleDrive(file) {
                const metadata = {
                    name: file.name,
                    mimeType: file.type,
                    parents: ['appDataFolder'] // Store in app-specific folder
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleDriveToken}`
                    },
                    body: form
                });
            }

            async function loadImages() {
                if (!db) {
                    console.error('Database not initialized');
                    return;
                }

                showLoading();

                try {
                    // Load from IndexedDB
                    const localImages = await loadFromIndexedDB();
                    
                    // Load from Google Drive if signed in
                    let driveImages = [];
                    if (googleDriveToken) {
                        driveImages = await loadFromGoogleDrive();
                    }

                    // Combine and sort images
                    allImages = [...localImages, ...driveImages].sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );

                    renderGallery(allImages);
                } catch (error) {
                    console.error('Error loading images:', error);
                    alert('Error loading images. Please try again.');
                } finally {
                    hideLoading();
                }
            }

            // Load from IndexedDB
            function loadFromIndexedDB() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readonly');
                    const store = transaction.objectStore('images');
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const images = request.result.filter(img => img.password === currentPassword);
                        // Get saved names from localStorage
                        const savedNames = JSON.parse(localStorage.getItem('imageNames') || '{}');
                        
                        // Apply saved names to images
                        images.forEach(img => {
                            if (savedNames[img.id]) {
                                img.name = savedNames[img.id];
                            }
                        });
                        
                        resolve(images);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }

            // Load from Google Drive
            async function loadFromGoogleDrive() {
                const response = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    fields: 'files(id, name, modifiedTime, webContentLink)'
                });

                return response.result.files.map(file => ({
                    id: file.id,
                    name: file.name,
                    timestamp: file.modifiedTime,
                    data: file.webContentLink,
                    password: currentPassword
                }));
            }

            function renderGallery(images) {
                const gallery = document.getElementById('gallery');
                if (!images.length) {
                    gallery.innerHTML = `
                        <div class="empty-gallery">
                            <i class="fas fa-images"></i>
                            <h3>No images found</h3>
                            <p>Upload some images to get started!</p>
                        </div>`;
                    return;
                }

                gallery.innerHTML = '';
                images.forEach(img => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    card.innerHTML = `
                        <img src="${img.data}" alt="${img.name}" onclick="openModal(this.src)">
                        <div class="image-info">
                            <div class="name-edit-container">
                                <span class="image-name">${img.name}</span>
                                <input type="text" class="edit-name-input" value="${img.name}">
                            </div>
                            <div class="buttons">
                                <button class="edit-btn" onclick="startEdit(this)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="save-btn" onclick="saveEdit(this, ${img.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="cancel-btn" onclick="cancelEdit(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="delete-btn" onclick="showDeleteConfirmation(${img.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    gallery.appendChild(card);
                });
            }

            function openModal(src) {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                modal.classList.add('active');
                modalImg.src = src;
            }

            function closeModal() {
                const modal = document.getElementById('imageModal');
                modal.classList.remove('active');
            }

            function startEdit(btn) {
                const container = btn.closest('.image-info');
                const nameSpan = container.querySelector('.image-name');
                const input = container.querySelector('.edit-name-input');
                const saveBtn = container.querySelector('.save-btn');
                const cancelBtn = container.querySelector('.cancel-btn');
                
                nameSpan.style.display = 'none';
                input.style.display = 'block';
                btn.style.display = 'none';
                saveBtn.classList.add('show');
                cancelBtn.classList.add('show');
                input.focus();
            }

            function cancelEdit(btn) {
                const container = btn.closest('.image-info');
                const nameSpan = container.querySelector('.image-name');
                const input = container.querySelector('.edit-name-input');
                const editBtn = container.querySelector('.edit-btn');
                const saveBtn = container.querySelector('.save-btn');
                const cancelBtn = container.querySelector('.cancel-btn');
                
                nameSpan.style.display = 'block';
                input.style.display = 'none';
                editBtn.style.display = 'flex';
                saveBtn.classList.remove('show');
                cancelBtn.classList.remove('show');
            }

            async function saveEdit(btn, imageId) {
                const container = btn.closest('.image-info');
                const nameSpan = container.querySelector('.image-name');
                const input = container.querySelector('.edit-name-input');
                const newName = input.value.trim();
                
                if (!newName) {
                    alert('Please enter a valid name');
                    return;
                }

                try {
                    // Save to localStorage
                    const savedNames = JSON.parse(localStorage.getItem('imageNames') || '{}');
                    savedNames[imageId] = newName;
                    localStorage.setItem('imageNames', JSON.stringify(savedNames));

                    // Update UI
                    nameSpan.textContent = newName;
                    cancelEdit(btn);
                } catch (error) {
                    console.error('Error saving name:', error);
                    alert('Error saving name. Please try again.');
                }
            }

            // Show delete confirmation dialog
            function showDeleteConfirmation(imageId) {
                const dialog = document.getElementById('confirmationDialog');
                const confirmBtn = document.getElementById('confirmButton');
                
                // Set up the confirm button to delete the image when clicked
                confirmBtn.onclick = function() {
                    closeConfirmationDialog();
                    deleteImage(imageId);
                };
                
                dialog.classList.add('active');
            }

            // Close the confirmation dialog
            function closeConfirmationDialog() {
                const dialog = document.getElementById('confirmationDialog');
                dialog.classList.remove('active');
            }

            async function deleteImage(imageId) {
                showLoading();
                try {
                    // Delete from IndexedDB
                    await deleteFromIndexedDB(imageId);
                    
                    // Delete from Google Drive if signed in
                    if (googleDriveToken) {
                        await deleteFromGoogleDrive(imageId);
                    }

                    // Remove saved name
                    const savedNames = JSON.parse(localStorage.getItem('imageNames') || '{}');
                    delete savedNames[imageId];
                    localStorage.setItem('imageNames', JSON.stringify(savedNames));

                    await loadImages();
                } catch (error) {
                    console.error('Error deleting image:', error);
                    alert('Error deleting image. Please try again.');
                } finally {
                    hideLoading();
                }
            }

            function deleteFromIndexedDB(imageId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['images'], 'readwrite');
                    const store = transaction.objectStore('images');
                    const request = store.delete(imageId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async function deleteFromGoogleDrive(fileId) {
                await gapi.client.drive.files.delete({
                    fileId: fileId
                });
            }

            let currentSort = 'date';
            function sortImages(type) {
                if (type === currentSort) return;
                
                currentSort = type;
                const buttons = document.querySelectorAll('.sort-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');

                const gallery = document.getElementById('gallery');
                const cards = Array.from(gallery.children);
                
                cards.sort((a, b) => {
                    const aInfo = a.querySelector('.image-name').textContent;
                    const bInfo = b.querySelector('.image-name').textContent;
                    
                    switch(type) {
                        case 'name':
                            return aInfo.localeCompare(bInfo);
                        case 'date':
                            return new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp);
                        case 'size':
                            return parseInt(b.dataset.size) - parseInt(a.dataset.size);
                        default:
                            return 0;
                    }
                });

                gallery.innerHTML = '';
                cards.forEach(card => gallery.appendChild(card));
            }

            function showLoading() {
                document.getElementById('loading').classList.add('active');
            }

            function hideLoading() {
                document.getElementById('loading').classList.remove('active');
            }

            // Add event listener for double-click
            document.getElementById('deleteAllBtn').addEventListener('click', function() {
                if (clickTimer) {
                    clearTimeout(clickTimer); // Clear the timer if it's already set
                    clickTimer = null; // Reset the timer
                    confirmDeleteAll(); // Call the delete function on double-click
                } else {
                    clickTimer = setTimeout(() => {
                        clickTimer = null; // Reset the timer after delay
                    }, clickDelay);
                }
            });

            function confirmDeleteAll() {
                // Show confirmation dialog
                const dialog = document.getElementById('confirmationDialog');
                const confirmMessage = document.getElementById('confirmationMessage');
                const confirmBtn = document.getElementById('confirmButton');
                
                confirmMessage.textContent = 'Are you sure you want to delete image? This action cannot be undone.';
                
                // Set up the confirm button to delete all images when clicked
                confirmBtn.onclick = function() {
                    closeConfirmationDialog();
                    deleteAllImages();
                };
                
                dialog.classList.add('active');
            }

            async function deleteAllImages() {
                showLoading();
                try {
                    // Get all images from IndexedDB
                    const images = await loadFromIndexedDB();
                    const deletePromises = images.map(image => deleteFromIndexedDB(image.id)); // Create an array of promises

                    // Wait for all delete operations to complete
                    await Promise.all(deletePromises);

                    // Optionally, delete from Google Drive if signed in
                    if (googleDriveToken) {
                        const deleteDrivePromises = images.map(image => deleteFromGoogleDrive(image.id)); // Create an array of promises
                        await Promise.all(deleteDrivePromises);
                    }

                    // Clear saved names
                    localStorage.setItem('imageNames', '{}');

                    alert('All images have been deleted successfully!');
                    loadImages(); // Refresh the gallery after deletion
                } catch (error) {
                    console.error('Error deleting all images:', error);
                    alert('Error deleting images. Please try again.');
                } finally {
                    hideLoading();
                }
            }

            // Backup images function
            async function backupImages() {
                if (allImages.length === 0) {
                    alert('No images to backup!');
                    return;
                }

                showLoading();
                try {
                    // Create a backup object with all images
                    const backup = {
                        timestamp: new Date().toISOString(),
                        images: allImages.map(img => ({
                            id: img.id,
                            name: img.name,
                            data: img.data,
                            timestamp: img.timestamp,
                            password: img.password
                        }))
                    };

                    // Convert to JSON and create a blob
                    const jsonString = JSON.stringify(backup);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    // Create download link and trigger download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `image-vault-backup-${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    alert('Backup created successfully!');
                } catch (error) {
                    console.error('Error creating backup:', error);
                    alert('Error creating backup. Please try again.');
                } finally {
                    hideLoading();
                }
            }

            // Import images function
            async function importImages() {
                const file = document.getElementById('importInput').files[0];
                if (!file) {
                    alert('No file selected!');
                    return;
                }

                showLoading();
                try {
                    // Read the file
                    const fileContent = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(e);
                        reader.readAsText(file);
                    });
                    
                    // Parse the JSON
                    const backup = JSON.parse(fileContent);
                    
                    if (!backup.images || !Array.isArray(backup.images)) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Filter images for current password
                    const filteredImages = backup.images.filter(img => img.password === currentPassword);
                    
                    if (filteredImages.length === 0) {
                        alert('No images found for your account in this backup file.');
                        hideLoading();
                        return;
                    }
                    
                    // Import each image
                    let importCount = 0;
                    for (const img of filteredImages) {
                        // Check if image already exists by comparing data
                        const existingImages = await loadFromIndexedDB();
                        const exists = existingImages.some(existing => 
                            existing.data === img.data && existing.name === img.name
                        );
                        
                        if (!exists) {
                            // Save to IndexedDB without the id to avoid conflicts
                            const { id, ...imageData } = img;
                            await saveToIndexedDB(imageData);
                            importCount++;
                        }
                    }
                    
                    document.getElementById('importInput').value = '';
                    alert(`Successfully imported ${importCount} new images!`);
                    loadImages();
                } catch (error) {
                    console.error('Error importing images:', error);
                    alert('Error importing images. Please check if the file is a valid backup.');
                } finally {
                    hideLoading();
                }
            }

            // Initialize Google Sign-in when page loads
            window.onload = initGoogleSignIn;
        </script>
    </div>
</body>
</html>